<!DOCTYPE html>
<html lang="zh">
<head>
	<meta charset="UTF-8">
	<title>Mikan Project RSS 缓存服务器后台</title>
</head>
<body>
<div id="app">
	<span>{{message}}</span>
	<label>
		<input
			:value="sitePrefixInput"
			@input="setSitePrefix"
			placeholder="site prefix"
		/>
	</label>
	<label>
		<input
			:value="siteMatcherInput"
			@input="setSiteMatcher"
			placeholder="site contains"
		/>
	</label>
	<hr/>
	<table>
		<tr>
			<th>ID</th>
			<th>网站源</th>
			<th>Regex</th>
			<th>注释</th>
			<th>状态</th>
			<th>添加时间</th>
			<th>变动时间</th>
			<th>最近成功访问时间</th>
			<th>连续访问失败计数</th>
		</tr>
		<tr v-for="followItem of followList">
			<td>{{followItem.id}}</td>
			<td>{{followItem.rssSite}}</td>
			<td>{{followItem.regexFilter}}</td>
			<td>{{followItem.comment}}</td>
			<td>{{followItem.enabled==1 ? '启用':'关闭'}}</td>
			<td>{{formatDate(followItem.followAddedTime)}}</td>
			<td>{{formatDate(followItem.followModifiedTime)}}</td>
			<td>{{formatDate(followItem.lastUpdateSucceedTime)}}</td>
			<td>{{followItem.updateContinueFailCounter}}</td>
		</tr>
	</table>
</div>
</body>
<script type="module">
	import {createApp} from './js/lib/vue.esm-browser.js'
	import {getFull} from './js/request.js'
	import {verifyFollowList} from "./js/indexUtils.js";

	createApp({
		el: "#app",
		data() {
			return {
				message: 'Hello Vue!',
				followList: [],
				fromId: 0,
				sitePrefixInput: '',
				siteMatcherInput: ''
			}
		},
		methods: {
			loadFollowList() {
				getFull(
					'/rss/follow/list',
					{
						fromId: this.fromId,
						pageSize: 20,
						sitePrefix: this.sitePrefixInput,
						siteMatcher: this.siteMatcherInput
					},
					(code, msg, body) => {
						console.log(body)
						this.followList = this.followList.concat(body);
						let newFromId = -1;
						for (let followItem in body) {
							newFromId = newFromId > followItem.id ? followItem.id : newFromId;
						}
						if (this.fromId >= 0) {
							this.fromId = newFromId;
						}
					},
					(error) => {
						alert('网络异常！');
						console.log(error);
					},
					(error) => {
						alert('处理异常！');
						console.log(error);
					},
					(body) => {
						verifyFollowList(body);
					},
					(error, body) => {
						alert('非法数据！');
						console.log(error);
						console.log(body)
					}
				);
			},
			setSitePrefix(event) {
				this.sitePrefixInput = event.target.value;
				this.fromId = 0;
			},
			setSiteMatcher(event) {
				this.siteMatcherInput = event.target.value;
				this.fromId = 0;
			},
			formatDate(unixTimestamp) {
				console.log('unixTimestamp:' + unixTimestamp)
				if (unixTimestamp == null || unixTimestamp === 0) {
					return 'N/A';
				}
				const date = new Date(unixTimestamp * 1000);
				const y = date.getFullYear();
				let m = date.getMonth() + 1;
				m = m < 10 ? ('0' + m) : m;
				let d = date.getDate();
				d = d < 10 ? ('0' + d) : d;
				let h = date.getHours();
				h = h < 10 ? ('0' + h) : h;
				let minute = date.getMinutes();
				minute = minute < 10 ? ('0' + minute) : minute;
				let second = date.getSeconds();
				second = second < 10 ? ('0' + second) : second;
				return y + '-' + m + '-' + d + ' ' + h + ':' + minute + ':' + second;
			}
		},
		mounted() {
			this.loadFollowList()
		}
	}).mount('#app')
</script>


</html>