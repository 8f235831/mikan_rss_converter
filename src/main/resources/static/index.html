<!DOCTYPE html>
<html lang="zh">
<head>
	<meta charset="UTF-8">
	<title>Mikan Project RSS 缓存服务器后台</title>
	<!-- Import style -->
	<link rel="stylesheet" href="./css/lib/element.css"/>
	<!-- Import Vue 3 -->
	<script src="./js/lib/vue.global.js"></script>
	<!-- Import component library -->
	<script src="./js/lib/element.full.js"></script>
</head>
<body>
<div id="app">
	<span>{{ message }}</span>
	<label>
		<input
			:value="sitePrefixInput"
			@input="setSitePrefix"
			placeholder="site prefix"
		/>
	</label>
	<label>
		<input
			:value="siteMatcherInput"
			@input="setSiteMatcher"
			placeholder="site contains"
		/>
	</label>
	<hr/>
	<el-table :data="followList" style="width: 100%">
		<el-table-column prop="id" label="ID"></el-table-column>
		<el-table-column prop="rssSite" label="网站源"></el-table-column>
		<el-table-column prop="regexFilter" label="Regex"></el-table-column>
		<el-table-column prop="comment" label="注释"></el-table-column>
		<el-table-column label="状态">
			<template #default="scope">
				{{ scope.row.enabled ? '启用' : '关闭' }}
			</template>
		</el-table-column>
		<el-table-column prop="followAddedTime" label="添加时间" :formatter="addedDateFormatter">
		</el-table-column>
		<el-table-column prop="followModifiedTime" label="变动时间" :formatter="modifiedDateFormatter"></el-table-column>
		<el-table-column prop="lastUpdateSucceedTime" label="最近成功访问时间" :formatter="lastUpdateDateFormatter"></el-table-column>
		<el-table-column prop="updateContinueFailCounter" label="连续访问失败计数"></el-table-column>
	</el-table>
</div>
</body>
<script type="module">
	import {getFull} from './js/request.js'
	import {verifyFollowList, formatDate} from "./js/indexUtils.js";

	const app = Vue.createApp({
		el: "#app",
		data() {
			return {
				message: 'Hello Vue!',
				followList: [],
				sitePrefixInput: '',
				siteMatcherInput: ''
			}
		},
		methods: {
			loadFollowList() {
				getFull(
					'/rss/follow/list',
					{
						fromId: 0,
						pageSize: 100,
						sitePrefix: this.sitePrefixInput,
						siteMatcher: this.siteMatcherInput
					},
					(code, msg, body) => {
						console.log(body)
						this.followList = body;
					},
					(error) => {
						alert('网络异常！');
						console.log(error);
					},
					(error) => {
						alert('处理异常！');
						console.log(error);
					},
					(body) => {
						verifyFollowList(body);
					},
					(error, body) => {
						alert('非法数据！');
						console.log(error);
						console.log(body)
					}
				);
			},
			setSitePrefix(event) {
				this.sitePrefixInput = event.target.value;
				this.fromId = 0;
			},
			setSiteMatcher(event) {
				this.siteMatcherInput = event.target.value;
				this.fromId = 0;
			},
			addedDateFormatter(row, column) {
				return formatDate(row.followAddedTime);
			},
			modifiedDateFormatter(row, column) {
				return formatDate(row.followModifiedTime);
			},
			lastUpdateDateFormatter(row, column) {
				return formatDate(row.lastUpdateSucceedTime);
			},

		},
		mounted() {
			this.loadFollowList()
		}
	});
	app.use(ElementPlus);
	app.mount('#app')
</script>


</html>